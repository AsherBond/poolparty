#!/usr/bin/env ruby
$:.unshift(File.join(File.dirname(__FILE__), "..", "lib"))
require "rubygems"
require 'net/http'
require 'json'
#require "poolparty/lite"
require 'poolparty'

status = ARGV.shift || "running" # or pending or terminated
schema = ::PoolParty::Cloud::Cloud.load_from_json(ENV['CLOUDS_JSON_FILE'] || '/etc/poolparty/clouds.json')

def get_json_stats_from(ip, port)
  Net::HTTP.start(ip, port) {|http| http.get('/stats') }.body rescue "{}"
end

#ips = %x[server-list-active internal_ip].split("\t")
ips = schema.describe_instances.select_with_hash(:status=>'running').collect{|n| n.ip} #TODO: needs to filter to only this cloud

minimum_instances = schema.dsl_options.minimum_instances
maximum_instances = schema.dsl_options.maximum_instances

if ips.size < minimum_instances
  puts "Cloud is too small, need to expand"
 %x[server-cloud-elections expand]
  exit(0)
elsif ips.size > maximum_instances
  puts "Cloud is too big, need to contract"
 %x[server-cloud-elections contract]
  exit(0)
end

total_json_hash = {}
ips.each do |ip|
  node_hsh = JSON.parse(get_json_stats_from(ip, 8642))
  total_json_hash.merge!(node_hsh) if node_hsh
end

candidates = {:expand => 0, :contract => 0, :elected_action => nil}
candidates.each do |action, ballots|
  total_json_hash.each do |ip, node_hsh|
    candidates[action]+=1 if node_hsh["nominations"] && node_hsh["nominations"].include?(action.to_s)
    candidates[:elected_action] = node_hsh["elected_action"]
  end
end

# Expand the cloud if 50+% of the votes are for expansion
# Contract the cloud if 51+% of the votes are for contraction
@elected_action = candidates[:elected_action] || "none"
puts "checking nominations"
if (candidates[:expand] - candidates[:contract])/total_json_hash.size > 0.5
  %x[server-cloud-elections expand] unless @elected_action == "expand"
  @elected_action = "expand"
elsif (candidates[:contract] - candidates[:expand])/total_json_hash.size > 0.5
  %x[server-cloud-elections contract] unless @elected_action == "contract"
  @elected_action = "contract"
end      

puts "Elected action: #{@elected_action}"