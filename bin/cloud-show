#!/usr/bin/env ruby
$:.unshift(File.dirname(__FILE__) + "/../lib")
require "poolparty"
# require "poolpartycl"
require 'git-style-binary/command'

GitStyleBinary.command do
  @theme = :short
  
  version "PoolParty cloud command"  
  banner <<-EOS
Usage: #{$0} #{all_options_string} COMMAND [ARGS]

EOS

  short_desc "List the clouds"

  run do |command|    

    @loaded_clouds.each do |cld|
      
        puts "\nFrom #{$pool_specfile}\n"
        print_with_nice_printer "Cloud: #{cld.name}", [
          "instances #{cld.minimum_instances}..#{cld.maximum_instances}",
          "keypair #{cld.keypair}",
          "using #{cld.remote_base.class.to_s.top_level_class}"
        ] do |printer|
          if cld.nodes(:status => "running").size > 0
            printer.empty
            printer.center("Active instances")
            printer << cld.nodes(:status => "running").map{|a| a.ip.strip rescue nil }.compact.join("\n")
          end
          if cld.nodes(:status => "pending").size > 0
            printer.empty
            printer.center "Pending instances"
            printer << cld.nodes(:status => "pending").map{|a| a.to_s}.join("\n")
          end
          printer.empty
        end
      
    end
    
  end
end