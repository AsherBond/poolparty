#!/usr/bin/env ruby
$:.unshift(File.dirname(__FILE__) + "/../lib")
require "poolparty"

require 'git-style-binary/command'

GitStyleBinary.command do  
  version "PoolParty #{$0} command"  
  banner <<-EOS
Usage: #{$0} #{all_options_string}

  combines bootstrap and configures an instance or multiple instances
EOS

  short_desc "combines bootstrap and configures an instance or multiple instances"

  run do |command|
    @loaded_clouds.each do |cld|
      
      # If an IP or DNS name is given, bootstrap that node, otherwise, bootstrap all running nodes.
      if cld.nodes.empty?
        puts "No nodes to provision"
      else
        # Call before_provision callback on cloud
        cld.call_before_provision_callbacks
        
        if command[:inst_num]
          vputs "\nConfiguring: #{nodes[o.inst_num]}\n--------------------"
          address = cld.nodes[ command[:inst_num] ]
          ::PoolParty::Provision::BootStrapper.new( address[:ip], :cloud => cld )
          ::PoolParty::Provision::DrConfigure.new( address[:ip], :cloud => cld )
          cld.call_after_provision_callbacks
        else
          cld.nodes(:status => "running").each do |address|
            cld.vputs "\nConfiguring: #{address[:ip]}\n--------------------"      
            ::PoolParty::Provision::BootStrapper.new( address[:ip], :cloud => cld )
            ::PoolParty::Provision::DrConfigure.new( address[:ip], :cloud => cld )
            cld.call_after_provision_callbacks
          end
        end
      end
      
    end    
  end
end