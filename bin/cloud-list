#!/usr/bin/env ruby
$:.unshift(File.dirname(__FILE__) + "/../lib")

require "poolparty"
require 'git-style-binary/command'

GitStyleBinary.command do
  banner <<-EOS
Usage: #{$0} #{all_options_string}

  List the clouds and their nodes
  e.g. show a list of the current instances on the cloud
EOS

  opt :instance_id, "Describe a specific instance", :type => String, :default => nil

  short_desc "show a list of the current instances on the clouds"

  run do |command|
    @loaded_clouds.each do |cld|
      if command[:instance_id]
        require 'pp'
        pp result = cld.nodes(:instance_id=>command[:instance_id])
      else
        msg = [
          "Listing cloud #{cld.name}",
          " <white>Active instances</white>",
          "----------------------------"
        ]
        cld.nodes(:status => "running").each do |a| 
          msg << "  #{a[:instance_id] || a[:id]}\t#{a[:ip] ||a[:public_ip] }"
        end
        
        if cld.describe_instances(:status => "pending").size > 0
          msg << " Pending instances"
          msg << "----------------------------"
          msg << "  #{a[:instance_id] || a[:id]}\t#{a[:ip] ||a[:public_ip] }"
        end
        
        print_msg(msg)
      end
      
    end
  end
end